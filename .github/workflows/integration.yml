name: Integration Tests

on:
  # Manual trigger only
  # Note: These tests currently fail due to Vagrant SSH issues during provisioning
  # Run manually via Actions tab when needed
  workflow_dispatch:

jobs:
  integration-test:
    name: Integration Tests (Docker)
    runs-on: ubuntu-latest

    timeout-minutes: 45

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Install Vagrant
        run: |
          wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt-get update && sudo apt-get install vagrant -y
          vagrant --version

      - name: Verify Docker
        run: |
          docker info
          docker --version

      - name: Configure Docker access for Vagrant
        run: |
          # Ensure current user can access Docker socket
          sudo chmod 666 /var/run/docker.sock
          # Verify Docker works without sudo
          docker ps

      - name: Run integration tests
        env:
          VVV_INTEGRATION_TEST: "1"
        run: bun test tests/integration/integration.test.ts --timeout 900000

      - name: Upload test artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-logs
          path: /tmp/vvv-test-*/
          retention-days: 3
          if-no-files-found: ignore
